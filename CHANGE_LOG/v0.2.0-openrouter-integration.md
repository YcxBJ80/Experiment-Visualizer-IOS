# v0.2.0 - OpenRouter 集成与流式渲染

**日期**: 2025-12-06

## 概述

在基础框架上接入 OpenRouter API，实现 SSE 流式渲染，将网页端核心逻辑移植到 iOS/macOS 客户端。支持本地会话持久化。

---

## 新增文件

### 1. `Models/Conversation.swift`
对话模型，管理会话元数据：
- `id`, `title`, `messages`, `createdAt`, `updatedAt`
- `latestHTML` 计算属性：获取最新 HTML 内容用于 WebView 渲染

### 2. `Services/APIClient.swift`
OpenRouter API 客户端：
- **配置管理**：`APIConfig` 枚举管理 API Key、基础 URL、默认模型
- **流式请求**：`streamChat(prompt:model:)` 返回 `AsyncThrowingStream<String, Error>`
- **SSE 解析**：逐行解析 `data: {...}` 格式，提取 `delta.content`
- **系统提示词**：引导模型生成可交互 HTML，使用深色主题配色

### 3. `Stores/ChatStore.swift`
本地状态容器（`@Observable`）：
- **会话管理**：`conversations` 列表、`selectedConversationID`
- **流式状态**：`currentHTML`（实时更新）、`isLoading`、`streamBuffer`
- **持久化**：JSON 文件存储到 Documents 目录
- **错误处理**：`errorMessage` 显示 API 错误

---

## 修改文件

### `Models/ChatMessage.swift`
扩展消息模型：
- 新增 `conversationId: UUID` 关联会话
- 新增 `isStreaming: Bool` 标记流式状态
- 新增 `system` 角色
- `ContentType` 改为 `String` 原始值便于编解码

### `ContentView.swift`
重构为 ChatStore 驱动：
- 使用 `@State private var store = ChatStore()` 管理状态
- 侧边栏绑定 `store.conversations`，支持选择、删除、新建会话
- 主视图绑定 `store.currentHTML`，实时显示流式 HTML
- 输入栏触发 `store.sendMessage(prompt)`
- 工具栏添加「+」按钮创建新对话
- 加载中按钮变为「停止」图标

---

## 技术要点

1. **SSE 流式解析**
   - 使用 `URLSession.shared.bytes(for:)` 获取异步字节流
   - 逐行读取，解析 `data: {...}` 格式
   - 遇到 `[DONE]` 标记结束

2. **Swift Concurrency**
   - `actor APIClient` 保证线程安全
   - `AsyncThrowingStream` 暴露流式内容
   - `Task` 管理可取消的流式任务

3. **状态管理**
   - `@Observable` + `@MainActor` 保证 UI 线程更新
   - 流式内容实时追加到 `currentHTML`，WebView 即时刷新

4. **本地持久化**
   - `Codable` 序列化 `[Conversation]`
   - 写入 `Documents/conversations.json`

---

## 配置说明

在 `Info.plist` 或环境变量中设置：
```
OPENROUTER_API_KEY = sk-or-v1-xxxxx
```

或修改 `APIClient.swift` 中的 `openRouterAPIKey` 硬编码（不推荐）。

---

## 下一步

- [ ] 添加 API Key 输入界面
- [ ] 支持模型选择
- [ ] 优化流式渲染性能（节流更新）
- [ ] 添加停止生成功能
- [ ] 支持会话重命名

